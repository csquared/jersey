#! /usr/bin/env ruby

require 'uri'
require 'net/http'
require 'openssl'
require_relative '../lib/jersey/vault_crypt'

unless ARGV[0] && ARGV[1]
puts "
  Usage:

  load-env <file.json> <server>
"
exit 1
end

blob = File.read(ARGV[0])
uri  = URI.parse(ARGV[1])
http = Net::HTTP.new(uri.host, uri.port)

request = Net::HTTP::Get.new("/pubkey")
loop do
  response = http.request(request)
  if response.code.to_i == 200
    @public_key = response.body
    break
  else
    p response.body
    sleep 1
  end
end

@rsa_key = OpenSSL::PKey::RSA.new(@public_key.unpack("m0")[0])
@cipher_json = VaultCrypt.encrypt(blob, [@rsa_key.public_key])

request = Net::HTTP::Post.new("/msg/env")
loop do
  request.body = @cipher_json
  response = http.request(request)
  case response.code.to_i
  when 200
    puts "ENV loaded"
    break
  when 400..499
    error = JSON.parse(response.body)['error']
    puts "Error: #{error['message']}"
    break
  else
    p response.body
    sleep 1
  end
end
